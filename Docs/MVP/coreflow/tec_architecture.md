# 日语学习APP技术架构文档
## 1. 系统架构图
### 1.1 整体架构
```plaintext
┌─────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation)                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  搜索模块    │  │  词条详情   │  │  个人收藏           │  │
│  │  SearchView  │  │ DetailView  │  │  FavoriteView      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                        业务层 (Domain)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 词典服务     │  │ 收藏服务    │  │  用户服务           │  │
│  │ DictService  │  │ FavService  │  │  UserService       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                        数据层 (Data)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 本地存储     │  │ 云同步      │  │  用户认证           │  │
│  │ RealmManager │  │ CloudKit    │  │  AppleAuth         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
 ``
```

### 1.2 模块依赖关系
```plaintext
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   UI 模块      │──────▶  业务逻辑模块  │──────▶  数据访问模块  │
└───────────────┘      └───────────────┘      └───────────────┘
        │                      │                      │
        │                      │                      │
        ▼                      ▼                      ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  SwiftUI 组件  │      │  业务模型对象  │      │   Realm/云存储 │
└───────────────┘      └───────────────┘      └───────────────┘
 ``
```

## 2. 技术栈选择
### 2.1 前端框架
SwiftUI + UIKit 混合架构

- SwiftUI ：作为主要UI框架
  
  - 优势：声明式UI编程，开发效率高，适配性好
  - 应用：搜索界面、词条详情、收藏列表等主要界面
- UIKit ：作为补充
  
  - 优势：成熟稳定，功能丰富
  - 应用：复杂交互组件、自定义控件、性能关键区域
选择理由 ：

- SwiftUI提供快速开发能力，适合MVP快速迭代
- 关键性能区域可降级到UIKit实现
- 混合架构平衡了开发效率与性能需求
### 2.2 本地存储
Realm 数据库

- 优势：
  
  - 跨平台支持
  - 对象映射简单直观
  - 查询性能优异
  - 支持加密
  - 轻量级，无需额外配置
- 应用：
  
  - 词典数据本地存储
  - 用户收藏数据
  - 学习记录与统计
### 2.3 云同步
CloudKit

- 优势：
  
  - 苹果原生支持
  - 与iCloud账户集成
  - 免费额度足够MVP阶段使用
  - 无需自建后端
- 应用：
  
  - 用户收藏数据同步
  - 学习进度同步
  - 用户设置同步
### 2.4 用户认证
Sign in with Apple

- 优势：
  - 一键登录，用户体验佳
  - 符合App Store审核要求
  - 保护用户隐私
  - 实现简单
## 3. 设计模式
### 3.1 主体架构：MVVM + Clean Architecture
MVVM (Model-View-ViewModel)

- Model : 核心数据模型，如词条、收藏项
- View : SwiftUI视图
- ViewModel : 视图状态管理，业务逻辑处理
Clean Architecture 分层

- Entities : 核心业务模型
- Use Cases : 业务逻辑封装
- Interface Adapters : 数据转换与适配
- Frameworks : 外部依赖（Realm、CloudKit等）
选择理由 ：

- MVVM与SwiftUI天然契合
- Clean Architecture提供清晰的责任分离
- 便于单元测试
- 模块化程度高，适合团队协作
### 3.2 辅助模式
- Repository模式 : 数据访问抽象
- Factory模式 : 对象创建
- Observer模式 : 数据变更通知
- Strategy模式 : 搜索策略、同步策略
## 4. 数据流设计
### 4.1 单向数据流
```plaintext
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   用户操作   │───▶│  状态更新   │───▶│   UI渲染    │
└─────────────┘    └─────────────┘    └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  数据持久化  │
                   └─────────────┘
 ``
```

- 用户操作触发Action
- ViewModel处理Action并更新State
- View根据State渲染UI
- 数据变更同步到持久层
### 4.2 离线优先策略
```plaintext
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  本地操作    │───▶│  本地存储   │───▶│   UI更新    │
└─────────────┘    └─────────────┘    └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  云端同步   │
                   └─────────────┘
 ``
```

- 所有操作优先写入本地数据库
- UI从本地数据库读取并显示
- 后台异步进行云同步
- 同步冲突采用最新优先策略
### 4.3 状态管理
- 本地状态 : SwiftUI @State, @StateObject
- 共享状态 : 环境对象 @EnvironmentObject
- 持久状态 : Realm对象观察
## 5. 核心模块详细设计
### 5.1 词典查询模块
```plaintext
┌─────────────────────────────────────────────────────────────┐
│                      SearchViewModel                         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 查询状态     │  │ 搜索历史    │  │  搜索建议           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      DictionaryService                       │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 精确查询     │  │ 模糊查询    │  │  拼音查询           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      RealmManager                            │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 词条模型     │  │ 索引优化    │  │  缓存策略           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
 ``
```

### 5.2 收藏管理模块
```plaintext
┌─────────────────────────────────────────────────────────────┐
│                      FavoriteViewModel                       │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 收藏列表     │  │ 收藏操作    │  │  分类管理           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      FavoriteService                         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 本地存储     │  │ 云同步      │  │  冲突解决           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
 ``
```

### 5.3 用户认证模块
```plaintext
┌─────────────────────────────────────────────────────────────┐
│                      UserViewModel                           │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 登录状态     │  │ 用户信息    │  │  设置管理           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      AuthService                             │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Apple登录    │  │ 游客模式    │  │  权限管理           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
 ``
```

## 6. 数据模型设计
### 6.1 词典数据模型
```swift
// 词条模型 - 数据层实体
class DictEntryEntity: Object {
    @Persisted(primaryKey: true) var id: String
    @Persisted var word: String              // 单词
    @Persisted var reading: String           // 读音
    @Persisted var partOfSpeech: String      // 词性
    @Persisted var definitions: List<DefinitionEntity> // 释义列表
    @Persisted var examples: List<ExampleEntity>   // 例句列表
}

// 释义模型 - 数据层实体
class DefinitionEntity: EmbeddedObject {
    @Persisted var meaning: String           // 中文释义
    @Persisted var notes: String?            // 注释
}

// 例句模型 - 数据层实体
class ExampleEntity: EmbeddedObject {
    @Persisted var sentence: String          // 日语例句
    @Persisted var translation: String       // 中文翻译
}
 ``
```

### 6.2 用户数据模型
```swift
// 用户模型 - 数据层实体
class UserEntity: Object {
    @Persisted(primaryKey: true) var id: String  // Apple ID标识符
    @Persisted var nickname: String?             // 昵称
    @Persisted var settings: UserSettingsEntity?       // 用户设置
    @Persisted var lastSyncTime: Date?           // 最后同步时间
}

// 用户设置 - 数据层实体
class UserSettingsEntity: EmbeddedObject {
    @Persisted var darkMode: Bool = false        // 深色模式
    @Persisted var fontSize: Int = 2             // 字体大小
    @Persisted var autoSync: Bool = true         // 自动同步
}
 ``
```

### 6.3 收藏数据模型
```swift
// 收藏夹模型 - 数据层实体
class FolderEntity: Object {
    @Persisted(primaryKey: true) var id: String = UUID().uuidString
    @Persisted var name: String                  // 收藏夹名称
    @Persisted var createdAt: Date = Date()      // 创建时间
    @Persisted var items: List<FavoriteItemEntity>     // 收藏项目
    @Persisted var syncStatus: Int = 0           // 同步状态
}

// 收藏项目 - 数据层实体
class FavoriteItemEntity: Object {
    @Persisted(primaryKey: true) var id: String = UUID().uuidString
    @Persisted var wordId: String                // 词条ID
    @Persisted var word: String                  // 单词
    @Persisted var reading: String               // 读音
    @Persisted var meaning: String               // 简要释义
    @Persisted var note: String?                 // 个人笔记
    @Persisted var addedAt: Date = Date()        // 添加时间
    @Persisted var syncStatus: Int = 0           // 同步状态
}
 ``
```

## 7. 技术实现关键点
### 7.1 性能优化
- 词典查询索引优化
  
  - 为常用查询字段建立索引
  - 实现高效的模糊搜索算法
- 资源加载策略
  
  - 懒加载非关键资源
  - 预加载可能需要的数据
- UI渲染优化
  
  - 避免大列表一次性加载
  - 使用分页加载技术
### 7.2 离线功能实现
- 核心词库预装
  
  - 应用包含基础词库
  - 首次启动解压到Realm数据库
- 增量更新机制
  
  - 词库版本控制
  - 按需下载词库更新
### 7.3 数据同步策略
- 增量同步
  
  - 仅同步变更数据
  - 使用时间戳标记变更
- 冲突解决
  
  - 基于时间戳的冲突检测
  - 用户可选择保留哪个版本
### 7.4 错误处理
- 网络错误
  
  - 优雅降级到离线模式
  - 后台重试机制
- 数据错误
  
  - 数据完整性验证
  - 自动修复策略
## 8. 第三方依赖
- RealmSwift : 本地数据库
- CloudKit : 云同步
- AuthenticationServices : Sign in with Apple
- AVFoundation : 语音合成与播放
## 9. 安全考虑
- 数据安全
  
  - Realm数据库加密
  - 敏感信息安全存储
- 用户隐私
  
  - 最小化数据收集
  - 明确的隐私政策
## 10. 扩展性设计
- 模块化架构
  
  - 松耦合设计
  - 接口抽象
- 功能扩展点
  
  - 预留API扩展接口
  - 插件化设计思想
通过以上架构设计，我们将为日语学习APP建立一个稳定、高效、可扩展的技术基础，确保MVP阶段的核心功能能够顺利实现，并为后续功能迭代提供良好的架构支持。